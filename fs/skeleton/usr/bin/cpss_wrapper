#! /bin/sh

. /etc/utils.sh

#
# reset and initialize the marvell parts in chimera
#

register_experiment CpssNoStart
register_experiment CpssNoInit
register_experiment Cpss10GOnly

die()
{
  echo "$0: $*" >&2
  pkill -x cpss
  exit 1
}

# Given a set of vlan identifiers to exclude, generate the
# range descriptions that exclude those identifiers.
vlan_ranges()
{
  local result vlans last final curr v dt range

  result=""
  vlans=$(echo "$@" | sed -e 's/ /\n/g' | sort -nu)

  last=${vlans##.* }
  final=$(($vlan_end+1))
  if [ "$last" = $vlan_end ]; then
    final=
  fi

  set -- $vlans $final
  curr=$vlan_start
  while [ $# -gt 0 ]; do
    v=$1
    shift
    dt=$(($v - $curr))
    if [ $dt -lt 0 ]; then
      # silently drop illegal values
      continue
    fi
    if [ $dt -gt 0 ]; then
       if [ $dt -eq 1 ]; then
         range=$curr
       else
         range=$curr-$(($v-1))
       fi
       result="${result} ${range}"
    fi
    curr=$(($v + 1))
  done

  echo ${result}
}

# Generate the switchport allowed vlan lines with the appropriate
# ranges when passed a set of vlans to exclude.
generate_vlan_allow_lines()
{
  local range

  for range in $(vlan_ranges "$@"); do
    echo "switchport allowed vlan add ${range} outer_tag0_inner_tag1"
  done
}

vlan_start=1
vlan_end=4095

vlan_ooband=$(ptp-config -g vlan_ooband)
vlan_inband=$(ptp-config -g vlan_inband)
vlan_peer=$(ptp-config -g vlan_peer)
# Use vlan 4095 (reserved in 802.1q) for untagged traffic.
vlan_untagged=4095

port_poe=0/0
port_soc=0/4
port_modem=0/24
port_sfp=0/25

src_modem=${port_modem##0/}
src_sfp=${port_sfp##0/}

pci="/dev/switch"

# Take switch out of reset in case it was left that way
if [ -e /dev/gpio/3236_reset ]; then
  echo 0 >/dev/gpio/3236_reset/value
fi

if [ ! -d $pci ]; then
  # rescan the pci bus in case it was in reset
  echo 1 >/sys/bus/pci/rescan
  msleep 200
fi

if [ ! -d $pci ]; then
  die "PCI device for 3236 switch not found at '$pci'"
fi

# Check that vendor & device ID have expected values
vendor_id_expected="0x11ab"
vendor_id="$(cat ${pci}/vendor)"
device_id_expected="0xf410"
device_id="$(cat ${pci}/device)"
if [ "$vendor_id" != "$vendor_id_expected" ] || [ "$device_id" != "$device_id_expected" ]; then
  die "pci vendor_id ($vendor_id != $vendor_id_expected) or" \
      "device_id ($device_id != $device_id_expected) mismatch!"
fi

# Resetting the 3236 causes all the PCI BARs to be reset, so we need to remove
# the switch from the pci bus then rescan the pci bus at the end. Finally we
# need to enable the switch again.
echo 1 >$pci/remove
msleep 100
if [ ! -d $pci ]; then
  echo "$pci was removed successfully!"
else
  die "There is still a PCI device present after removal at: $pci"
fi

# If 3236_reset is available then the switch software reset line is available.
# Wait for 3236_ready to go high before starting cpss.
if [ -e /dev/gpio/3236_reset ]; then
  echo 1 >/dev/gpio/3236_reset/value
  msleep 100
  echo 0 >/dev/gpio/3236_reset/value
  bailout=0
  while [ ${bailout} -le 3 ]; do
    state=$(cat /dev/gpio/3236_ready/value)
    if [ ${state} -eq 1 ]; then
      echo "$0: 3236 is ready after reset!"
      break
    else
      bailout=$(($bailout+1))
      msleep 500
    fi
  done
  if [ ${bailout} -gt 3 ]; then
    die "Error: 3236 was NOT reset!"
  fi
fi

# reset phys
reset="2011_reset 3220_reset"
for n in $reset; do
  echo 1 >/dev/gpio/$n/value
done
msleep 100
for n in $reset; do
  echo 0 >/dev/gpio/$n/value
done

echo 1 >/sys/bus/pci/rescan
msleep 200
if [ ! -d $pci ]; then
  die "There is no PCI device at $pci after rescanning!"
else
  echo "Excellent! $pci has reappeared."
fi

echo "Finally, enabling the switch..."
echo 1 >$pci/enable

if experiment CpssNoStart; then
  echo "$0: experiment CpssNoStart is enabled, not starting cpss." >&2
  exit 0
fi

# start cpss as persistent server
pkill -x cpss
export CMDFS_ROOT=/usr/lib/cpss/scripts
ptyserver -p 4455 cpss -tty 2>&1 | logos cpss_pty &

# check that shell loaded and we get a prompt
# try a few times; we get one timeout at boot time, don't know why
success=0
for n in $(seq 3); do
  cpss_cmd <<EOF

EOF
  if [ $? = 0 ]; then
    success=1
    break
  fi
  echo "$0: still waiting for cpss prompt" >&2
  sleep 1
done
[ $success = 1 ] || die "no cpss prompt"
echo "$0: got cpss prompt"

# start configuring cpss
if experiment CpssNoInit; then
  echo "$0: experiment CpssNoInit enabled, skipping init and 2011 config." >&2
else

  # disable pager
  cpss_cmd <<EOF || die "failed to disable pager"
    debug
      set print pause disable
    end
EOF

  # init the switch, check for result
  cpss_cmd <<EOF | grep "Init system returned:0" || die "cpssInitSystem failed"
    cpssInitSystem 19,2,0
EOF

  # show cpss version
  echo show version | cpss_cmd

  # init 88x2011 (xfi/xaui transceiver)
  cpss_cmd <<EOF | grep "Successfully" || die "failed to initialize 2011"
    chimera
      init_2011
    end
EOF

  if experiment Cpss10GOnly; then
    echo "$0: experiment Cpss10GOnly is enabled, skipping vlans." >&2
    # configure just the 10G path
    cpss_cmd <<EOF || die "config failed"
      config
        interface range ethernet $port_modem,$port_sfp
          speed 10000 mode SR_LR
        exit
      end
EOF

  else
    modem_allow_vlans=$(generate_vlan_allow_lines $vlan_ooband $vlan_untagged)
    sfp_allow_vlans=$(generate_vlan_allow_lines $vlan_peer $vlan_ooband $vlan_untagged)

    # configure ports, vlans
    cpss_cmd <<EOF || die "config failed"
      cpss-api call cpssDxChBrgVlanRemoveVlanTag1IfZeroModeSet devNum 0 mode CPSS_DXCH_BRG_VLAN_REMOVE_TAG1_IF_ZERO_E
      cpss-api call cpssDxChBrgVlanRangeSet devNum 0 vidRange 4095
      config
        no counters mac counters reset-on-read all
        interface range vlan device 0 vid ${vlan_start}-${vlan_end}
        exit
        interface ethernet $port_poe
          speed 1000 mode SGMII
          switchport allowed vlan add $vlan_ooband untagged
          switchport pvid $vlan_ooband
        exit
        interface ethernet $port_soc
          speed 1000 mode 1000Base_X
          switchport allowed vlan add $vlan_ooband tagged
          switchport allowed vlan add $vlan_peer tagged
          switchport allowed vlan add $vlan_inband tagged
          switchport pvid $vlan_ooband
        exit
        interface ethernet $port_modem
          speed 10000 mode SR_LR
          jumbo-frame
          $modem_allow_vlans
          switchport allowed vlan add $vlan_untagged untagged
          switchport pvid $vlan_untagged
        exit
        interface ethernet $port_sfp
          speed 10000 mode SR_LR
          jumbo-frame
          $sfp_allow_vlans
          switchport allowed vlan add $vlan_untagged untagged
          switchport pvid $vlan_untagged
        end
      end
EOF
  fi
fi

# wait on ptyserver
wait

# exit badly to get babysitter to restart
exit 1
