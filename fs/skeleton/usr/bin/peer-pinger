#! /bin/sh

#
# ping the peer radio each second, and touch a file (up or down)
#

rm -f /tmp/peer-up /tmp/peer-down

duration=0
seconds_since_change=0
last=
while sleep 1; do
  addr=$(ptp-config -g peer_ipaddr)
  addr=${addr%%/*}
  log="false"

  if ! ping -q -c 1 -w 1 "$addr" 2>&1 >/dev/null; then
    new=down
  else
    new=up
  fi
  if [ "$last" != "$new" ]; then
    rm -f /tmp/peer-up /tmp/peer-down
    >/tmp/peer-"$new"
    log="true"
    seconds_since_change=0
  else
    # print every 2 min since last print
    if ! ((duration % 120)); then
      log="true"
    fi
  fi

  if [ "$log" == "true" ]; then
    echo "peer is $new changed $seconds_since_change seconds ago"
    duration=0
  fi

  ((duration++))
  ((seconds_since_change++))

  last="$new"
done
