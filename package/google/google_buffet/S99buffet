#!/bin/sh
#
#   Buffet service is a system daemon responsible for command dispatch and
# device state publishing on local and GCD cloud channels.
#
#   Note: Buffet is ported from ChromeOS as a binary so it expects the ChromeOS
# environment. Therefore, chroot is needed to execute buffet.
#

# Sanity check
[ -x /chroot/chromeos/bin/buffet ] || exit 0
[ -d /chroot/chromeos/etc/buffet ] || exit 0
[ -e /chroot/chromeos/var/run/dbus/system_bus_socket ] || exit 0

# Create necessary directories and dependencies to run Buffet.
mkdir -p /chroot/chromeos/var/run/buffet
mkdir -p /chroot/chromeos/etc/ssl/certs
# libcurl.so.4 in ChromeOS expected Equifax cert with hash name 578d5c04.0
ln -s /etc/ssl/certs/ca-certificates.crt /chroot/chromeos/etc/ssl/certs/578d5c04.0
# Copy resolv.conf and nsswitch.conf so Buffet can resolve hostname.
cp -p /etc/resolv.conf /chroot/chromeos/etc
cp -p /etc/nsswitch.conf /chroot/chromeos/etc

start() {
  echo "Starting buffet service..."
  chroot /chroot/chromeos /bin/buffet 2>&1 | logos buffet &

  [ $? -eq 0 ] && echo "Buffet started successfully" && exit 0
  echo "Failed to start buffet..." && exit 1
}

stop() {
  echo "Stop buffet not supported yet..."
  exit 1
}

restart() {
  stop
  start
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  restart|reload)
    restart
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
esac
