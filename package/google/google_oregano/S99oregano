#!/bin/sh
. /etc/utils.sh

if ! is-html-tv-ui; then
  echo "configured for sage"
  exit 0
fi

case "$1" in
  start)
    (
      wait-until-created /tmp/startupvideo.done
      if is-tv-box; then
        /app/oregano/runoregano 2>&1 | logos oregano 0 20000000 &
      else
        /app/oregano/runmarjoram 2>&1 | logos marjoram 0 20000000 &
      fi
    ) &
    ;;
  stop)
    # If startupvideo is running, it prevents miniclient from starting up.
    pkillwait -x startupvideo &
    # Stop the scripts invoked above due to 'start oregano' (which will also
    # stop any babysitters they may have).
    ( pkillwait -x 'runmarjoram' ;
      # End the Marjoram server (which will also end its babysitter).
      pkillwait -f '(dart.*)([m]arjoram\.dart)' ) &
    ( pkillwait -x 'runoregano' ;
      # End the Oregano ./start binary (which will also end its babysitter).
      pkillwait -x '\\./start' ;
      pkillwait -f '(content|browser)_shell' ) &
    # End any dangling HTTP request Futures from authTokens.dart attempts.
    pkillwait -f '(dart.*)([a]uthTokens\.dart)' &
    pkillwait -x waitpower &
    pkillwait -x netflix &
    pkillwait -x vudu &
    stop_sagesrv
    stop_adloader
    wait
    ;;
  restart)
    $0 stop; $0 start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
esac
