#!/bin/sh

case "$1" in
  start)
    mkdir -p /config/dnsmasq
    mkdir -p /tmp/dnsmasq
    touch /tmp/dnsmasq/acs.conf
    touch /tmp/dnsmasq/ipv6.conf
    if [ ! -e /config/dnsmasq/acs.conf ]; then
      ln -s /tmp/dnsmasq/acs.conf /config/dnsmasq/acs.conf
    fi
    if [ ! -e /config/dnsmasq/ipv6.conf ]; then
      ln -s /tmp/dnsmasq/ipv6.conf /config/dnsmasq/ipv6.conf
    fi
    for d in /config/dnsmasq/*; do
      [ -e "$d" ] || continue
      echo "--- $d: ---"
      cat "$d"
      echo "---"
    done | logos dnsmasq
    touch /tmp/resolv.conf.external  # just in case
    babysit 60 dnsmasq \
        --pid-file=/var/run/dnsmasq.pid \
        --conf-file=/etc/dnsmasq.conf \
        --resolv-file=/tmp/resolv.conf.external \
        --keep-in-foreground \
        --log-facility=- 2>&1 | logos dnsmasq &
    ;;
  stop)
    pkillwait -x dnsmasq
    ;;
  restart)
    $0 stop; $0 start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
    ;;
esac

exit 0
