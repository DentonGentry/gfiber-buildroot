#!/bin/sh

log()
{
  echo "$0:" "$@" >&2
}

log "starting."

while :; do
  log "waiting for reset button."
  wait-until-created /tmp/gpio/reset_button_msecs
  log "reset button pressed!  waiting for button release."
  if reset-button-held 4000; then
    log "switch-image requested."
    leds 0 15 0 15 0 15  # noisy leds to indicate we acknowledged the command
    sleep 5
    if ginstall -p other; then
      leds 0  # success
      log "rebooting in 10 seconds..."
      sleep 10
      reboot
    else
      leds 1 0 1 0  #failed
    fi
  fi
done
