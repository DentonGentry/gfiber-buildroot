#!/bin/sh
pid=$1
signal=$2
exe=$3

out=/user/core.gz
outdir=$(dirname "$out")
interesting_exe="siege chsrv sagesrv miniclient netflix browsertest python"

# Send all output to kernel log.  We don't want to use the 'logger' program
# here in case there's something wrong with syslogd (eg. it's the one core
# dumping).
exec >/dev/kmsg 2>&1

log()
{
  echo "$0:" $@ >&2;
}

log "pid $pid ($exe) dying on signal $2"

if [ ! -w "$outdir" ] || [ -e "$out" -a ! -w "$out" ]; then
  log "can't dump core: $out is not writable."
else
  interesting=
  for d in $interesting_exe; do
    [ "$d" = "$exe" ] && interesting=1
  done
  if [ -z "$interesting" ]; then
    log "'$exe' core dumps aren't interesting; skipping."
  else
    # read and compress the core dump from stdin, limiting max output size
    gzip -c | dd bs=1024 count=163840 2>/dev/null >"$out"
  fi
fi
