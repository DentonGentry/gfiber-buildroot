#!/bin/sh
#
# This script monitors CONTROL_PATH folder and decides which is the
# led sequence that has to be echoed to the LEDS_FILE.

# Output file.
LEDS_FILE="/tmp/gpio/leds"
CONTROL_PATH="/tmp/gpio/ledcontrol"

# Watched files.
DHCP_FILE="$CONTROL_PATH/dhcpbound"
ACS_FILE="$CONTROL_PATH/acsconnected"
TEMP_FILE="$CONTROL_PATH/overtemperature"
HDPAIRING_FILE="$CONTROL_PATH/hdd_bad_pair"

# Bit sequences.
ALL_LEDS_OFF="0"
HW_FAIL_LED_ON="1 0 1 0 1 0"
ACS_LED_ON="2 2 2 2 2 2" # solid blue
DHCP_BOUND_LED_ON="2 2 2 0 0 0" # fast blue
#TODO(irinams): this is a temporary sequence that will be used
#as a default one until the leds implementation is complete.
ANYTHING_ELSE="8 0"

watch-dirs $CONTROL_PATH |
while read f; do
  # Check if there is an ip address on the br0 interface.
  if [ -n "$(ip -f inet6 addr show dev br0 scope global)" ]; then
    echo "IPv6 address acquired on br0" > "$DHCP_FILE"
  else
    rm -f "$DHCP_FILE"
  fi

  # Check if the overtemperature, dhcp or acs file exist.
  if [ -f "$TEMP_FILE" ] || [ -f "$HDPAIRING_FILE" ]; then
    leds $HW_FAIL_LED_ON
  elif [ -f "$DHCP_FILE" ]; then
    leds $DHCP_BOUND_LED_ON
  elif [ -f "$ACS_FILE" ]; then
    leds $ACS_LED_ON
  else
    leds $ANYTHING_ELSE
  fi
done
