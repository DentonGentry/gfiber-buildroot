From 71881b73bfb39f72176b70590e053a860e3a2da1 Mon Sep 17 00:00:00 2001
From: Denton Gentry <dgentry@google.com>
Date: Thu, 11 Dec 2014 22:00:59 -0800
Subject: [PATCH] Add plugin for dtdns.com

---
 plugins/dtdns.c | 88 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 src/Makefile.am |  3 +-
 src/Makefile.in |  3 +-
 3 files changed, 92 insertions(+), 2 deletions(-)
 create mode 100644 plugins/dtdns.c

diff --git a/plugins/dtdns.c b/plugins/dtdns.c
new file mode 100644
index 0000000..65b9745
--- /dev/null
+++ b/plugins/dtdns.c
@@ -0,0 +1,88 @@
+/* Plugin for DtDNS
+ *
+ * Copyright (C) 2014  Google, Inc
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, visit the Free Software Foundation
+ * website at http://www.gnu.org/licenses/gpl-2.0.html or write to the
+ * Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+ * Boston, MA  02110-1301, USA.
+ */
+
+#include "plugin.h"
+
+#define DTDNS_UPDATE_IP_HTTP_REQUEST                   \
+	"GET %s?"							\
+	"id=%s&"							\
+	"pw=%s&"							\
+	"ip=%s "							\
+	"HTTP/1.0\r\n"							\
+	"Host: %s\r\n"							\
+	"User-Agent: " AGENT_NAME " " SUPPORT_ADDR "\r\n\r\n"
+
+static int request  (ddns_t       *ctx,   ddns_info_t *info, ddns_alias_t *alias);
+static int response (http_trans_t *trans, ddns_info_t *info, ddns_alias_t *alias);
+
+static ddns_system_t plugin = {
+	.name         = "default@dtdns.com",
+
+	.request      = (req_fn_t)request,
+	.response     = (rsp_fn_t)response,
+
+	.checkip_name = "myip.dtdns.com",
+	.checkip_url  = "/",
+
+	.server_name  = "www.dtdns.com",
+	.server_url   = "/api/autodns.cfm"
+};
+
+static int request(ddns_t *ctx, ddns_info_t *info, ddns_alias_t *alias)
+{
+	return snprintf(ctx->request_buf, ctx->request_buflen,
+			DTDNS_UPDATE_IP_HTTP_REQUEST,
+			info->server_url,
+			alias->name,
+			info->creds.password,
+			alias->address,
+			info->server_name.name);
+}
+
+static int response(http_trans_t *trans, ddns_info_t *UNUSED(info), ddns_alias_t *UNUSED(alias))
+{
+	char *resp = trans->p_rsp_body;
+
+	DO(http_status_valid(trans->status));
+
+	if (strstr(resp, "now points to"))
+		return RC_OK;
+
+	return RC_DYNDNS_RSP_NOTOK;
+}
+
+PLUGIN_INIT(plugin_init)
+{
+	plugin_register(&plugin);
+}
+
+PLUGIN_EXIT(plugin_exit)
+{
+	plugin_unregister(&plugin);
+}
+
+/**
+ * Local Variables:
+ *  version-control: t
+ *  indent-tabs-mode: t
+ *  c-file-style: "linux"
+ * End:
+ */
diff --git a/src/Makefile.am b/src/Makefile.am
index 935fdcd..2189397 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -18,5 +18,6 @@ inadyn_SOURCES += ../plugins/common.c		../plugins/dyndns.c	\
 		  ../plugins/generic.c		../plugins/sitelutions.c\
 		  ../plugins/tunnelbroker.c	../plugins/tzo.c	\
 		  ../plugins/zoneedit.c		../plugins/zerigo.c	\
-		  ../plugins/dhis.c		../plugins/duckdns.c
+		  ../plugins/dhis.c		../plugins/duckdns.c	\
+		  ../plugins/dtdns.c
 inadyn_LDADD	= -ldl
diff --git a/src/Makefile.in b/src/Makefile.in
index 9a1dd25..9d822a7 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -74,7 +74,8 @@ am_inadyn_OBJECTS = main.$(OBJEXT) ddns.$(OBJEXT) cache.$(OBJEXT) \
 	../plugins/sitelutions.$(OBJEXT) \
 	../plugins/tunnelbroker.$(OBJEXT) ../plugins/tzo.$(OBJEXT) \
 	../plugins/zoneedit.$(OBJEXT) ../plugins/zerigo.$(OBJEXT) \
-	../plugins/dhis.$(OBJEXT) ../plugins/duckdns.$(OBJEXT)
+	../plugins/dhis.$(OBJEXT) ../plugins/duckdns.$(OBJEXT) \
+	../plugins/dtdns.$(OBJEXT)
 inadyn_OBJECTS = $(am_inadyn_OBJECTS)
 inadyn_DEPENDENCIES =
 DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)/include
-- 
2.2.0.rc0.207.ga3a616c

