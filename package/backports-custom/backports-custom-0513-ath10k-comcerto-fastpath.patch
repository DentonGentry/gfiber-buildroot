From 013b10070f952edd8967ad6e9094fa5a4bf7a5a2 Mon Sep 17 00:00:00 2001
From: Denton Gentry <dgentry@google.com>
Date: Thu, 5 Jun 2014 21:19:37 -0700
Subject: [PATCH] Implement support for comcerto_wifi_rx_fastpath.

---
 .local-symbols                          |  1 +
 drivers/net/wireless/ath/ath10k/Kconfig |  8 ++++++++
 net/mac80211/rx.c                       | 23 +++++++++++++++++------
 3 files changed, 26 insertions(+), 6 deletions(-)

diff --git a/.local-symbols b/.local-symbols
index 0b50db1..67d8177 100644
--- a/.local-symbols
+++ b/.local-symbols
@@ -160,6 +160,7 @@ ATH10K_TRACING=
 ATH10K_DFS_CERTIFIED=
 ATH10K_USE_NCNB_DESCR=
 ATH10K_USE_NCNB_SKB=
+ATH10K_USE_COMCERTO_WIFI_FASTPATH=
 WCN36XX=
 WCN36XX_DEBUGFS=
 B43=
diff --git a/drivers/net/wireless/ath/ath10k/Kconfig b/drivers/net/wireless/ath/ath10k/Kconfig
index 5c53b6c..0c902cc 100644
--- a/drivers/net/wireless/ath/ath10k/Kconfig
+++ b/drivers/net/wireless/ath/ath10k/Kconfig
@@ -63,3 +63,11 @@ config ATH10K_USE_NCNB_SKB
 	---help---
 	  This option enables use of GFP_DMA_NCNB for sk_buffs on
 	  platforms like the Mindspeed Comcerto C2000.
+
+config ATH10K_USE_COMCERTO_WIFI_FASTPATH
+	bool "Atheros support for comcerto_wifi_rx_fastpath"
+	depends on ATH10K
+	default n
+	---help---
+	  This option enables use of comcerto_wifi_rx_fastpath() on
+	  Mindspeed Comcerto 2000 platforms.
diff --git a/net/mac80211/rx.c b/net/mac80211/rx.c
index 274ac84..6850173 100644
--- a/net/mac80211/rx.c
+++ b/net/mac80211/rx.c
@@ -1962,12 +1962,23 @@ ieee80211_deliver_skb(struct ieee80211_rx_data *rx)
 
 	if (skb) {
 		/* deliver to local stack */
-		skb->protocol = eth_type_trans(skb, dev);
-		memset(skb->cb, 0, sizeof(skb->cb));
-		if (rx->local->napi)
-			napi_gro_receive(rx->local->napi, skb);
-		else
-			netif_receive_skb(skb);
+#ifdef CPTCFG_ATH10K_USE_COMCERTO_WIFI_FASTPATH
+		extern int comcerto_wifi_rx_fastpath(struct sk_buff *skb);
+		int slowpath = 1;
+		if (!comcerto_wifi_rx_fastpath(skb)) {
+			/* fastpath handled this packet */
+			slowpath = 0;
+		}
+		if (slowpath)
+#endif
+		{
+			skb->protocol = eth_type_trans(skb, dev);
+			memset(skb->cb, 0, sizeof(skb->cb));
+			if (rx->local->napi)
+				napi_gro_receive(rx->local->napi, skb);
+			else
+				netif_receive_skb(skb);
+		}
 	}
 
 	if (xmit_skb) {
-- 
2.0.0.526.g5318336

